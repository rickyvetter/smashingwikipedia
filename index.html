<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smashing Wikipedia</title>
    <link rel="stylesheet" href="css/foundation.css" />
    <script src="js/vendor/modernizr.js"></script>
    <style>
    	.main{
    		margin-top:25px;
    	}
    </style>
  </head>
  <body>



  	<nav class="top-bar" data-topbar>
  	<ul class="title-area">
  			<li class="name">
  				<h1>
  					<a href="#/">Smashing Wikipedia</a>
  				</h1>
  			</li>
  			<li class="toggle-topbar">
  				<a class="random-button button" href="#/">Random!</a>
  			</li>
  		</ul>
  	</nav>
    
    <div class="row main">
      <div id="main" class="large-8 medium-8 small-12 columns">
      	<div id="wiki-article">
          Loading Wikipedia article...
      	</div>
      	<a class="random-button button expand" href="#/">Smash a random article!</a>
      </div>
      <div id="article-list" class="large-4 medium-4 small-12 columns">
        <p>Smash count: <span id="smash">0</span></p>
      	<p>Some carefully curated articles for your smashing enjoyment (just kidding, these are also random):</p>
      </div>
    </div>
    
    <script src="js/vendor/jquery.js"></script>
    <script src="js/foundation.min.js"></script>
    <script>
      $(document).foundation();
    </script>
    <script>
    var firstP = true;

    $(document).ready(function(){
	    findRandomArticle();
    });

    $(document).ready(function(){
	    $.getJSON( "http://en.wikipedia.org/w/api.php?action=query&list=random&format=json&rnnamespace=0&rnlimit=6&callback=?", function( data ) {
	    		var items = [];
	    		$.each( data.query.random, function( key, article ) {
						items.push( "<div class='article-button-container large-12 medium-12 small-12 columns'><a href='#/" + article.title + "' id='" + article.title + "' class='article-button button secondary expand'>" + article.title + "</a></div>" );
					});

					$( "<div/>", {
						"class": "article-list",
						html: items.join( "" )
					}).appendTo( "#article-list" );
	    });
    });

    function findRandomArticle(redirect)
    {
    	redirect = typeof redirect !== 'undefined' ? redirect : true;
    	var title;
    	$.getJSON( "http://en.wikipedia.org/w/api.php?action=query&list=random&format=json&rnnamespace=0&rnlimit=1&callback=?", function( data ) {
	    		title = data.query.random[0]["title"];
          if (redirect){
            window.location.href = "#/" + title;
          }
          return title;
	    });
    }

    function getFirstParagraph(title)
    {
    	$.getJSON( "http://en.wikipedia.org/w/api.php?action=query&prop=extracts&format=json&exlimit=10&exintro=&titles=" + title + "&callback=?", function( data ) {

  			var items = [];

  			for (var key in data.query.pages) {
				    articleID = data.query.pages[key];
				    articleTitle = data.query.pages[key].title;
				    articleExtract = data.query.pages[key].extract;
				}

        // extract or first p?
        if(firstP)
        {
          var articleExtract = $('<div/>').html(articleExtract);
          var content = articleExtract.find('p:first').html();
        }
        else{
          var content = articleExtract;
        }

				items.push( "<div id='title'><h1><a id='link-to-wiki' href='http://en.wikipedia.org/wiki/" + articleTitle + "' target='_blank'>" + articleTitle + "</a></h1></div>" );
				items.push( "<div id='text'>" + content + "<p><a href='http://en.wikipedia.org/wiki/" + articleTitle + "' target='_blank'>Read more on Wikipedia...</a></p></div><hr>" );

				$("#wiki-article").contents().remove();
				$( "<div/>", {html: items.join( "" )}).appendTo( "#wiki-article" );

				//add one to smash count
				smashCount = $("#smash").html();
				smashCount++;
				$('#smash').html(smashCount);
			});
    }

		function moveToArticle(title)
    {
			newLocation = "#/" + title;
		}

    $('.article-button').click(function(){
      $(this).remove;
    });


    $('.random-button').click(function(){
			findRandomArticle();		
		});

		$(window).on('hashchange', function() {
      if(location.hash[1] == '/')
      {
        var hash = location.hash.substr(2);
      }
      else{
        var hash = location.hash.substr(1);
      }
		  getFirstParagraph(hash);
		  moveToArticle(hash);

      $.each( $(".article-button"), function( key, value ) {
        //alert( key + ": " + value );
        if(value.hash.substr(2) == hash)
        {
          $.getJSON( "http://en.wikipedia.org/w/api.php?action=query&list=random&format=json&rnnamespace=0&rnlimit=1&callback=?", function( data ) {
              var items = [];
              $.each( data.query.random, function( key, article ) {
                items.push( "<a href='#/" + encodeURI(article.title) + "' id='" + article.title + "' class='article-button button secondary expand'>" + article.title + "</a>" );
              });

              $( "<div/>", {
                "class": "article-button-container large-12 medium-12 small-12 columns",
                html: items.join( "" )
              }).appendTo( ".article-list" );
          });
          $( ".article-button-container" ).remove( ":contains('" + hash + "')" );
        }
      });
		});

    function keyPress(e)
    {

      if (!e) e=window.event;
      var key=e.charCode ? e.charCode : e.keyCode ? e.keyCode : 0; 
      //alert(key);
      if(key == 39 || key == 100) 
      { 
        findRandomArticle();
      } 
      else if(key == 37 || key == 97) {
         history.back()
      }
      else if(key == 13) {
        //alert($("link-to-wiki").attr('href'));
        window.open($("#link-to-wiki").attr('href'));
      }
      else if(key == 49 || key == 50 || key == 51 || key == 52 || key == 53 || key == 54) {
        // keys 1-6
        //alert(key-48);
        window.location.href = $( ".article-list .article-button-container:nth-child(" + (key-48) + ") a" ).attr('href'); //link from corresponding story
      }
      return true; 
    }

    document.onkeypress = keyPress;


    
    </script>
  </body>
</html>
